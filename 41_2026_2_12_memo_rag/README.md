# ğŸ§  Conceptual MemoRAG Implementation

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ã€è«–æ–‡ **"MemoRAG: Boosting Long Context Processing with Global Memory-Enhanced Retrieval Augmentation"** (arXiv:2409.05591) ã®æ¦‚å¿µã‚’ã€**LangChain** ã¨ **OpenAI API** ã‚’ç”¨ã„ã¦Pythonã§å†ç¾ã—ãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆå®Ÿè£…ã§ã™ã€‚

å¾“æ¥ã®RAGï¼ˆæ¤œç´¢æ‹¡å¼µç”Ÿæˆï¼‰ãŒè‹¦æ‰‹ã¨ã™ã‚‹ã€Œå…¨ä½“åƒã®æŠŠæ¡ã€ã‚„ã€ŒæŠ½è±¡çš„ãªè³ªå•ã€ã«å¯¾ã—ã€**ã€Œä¸€åº¦å…¨ä½“ã‚’è¨˜æ†¶ï¼ˆMemoryï¼‰ã—ã€æ‰‹ãŒã‹ã‚Šï¼ˆCluesï¼‰ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰æ¤œç´¢ã™ã‚‹ã€** ã¨ã„ã†MemoRAGã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½“é¨“ã§ãã¾ã™ã€‚

## ğŸ“– MemoRAGã¨ã¯ï¼Ÿ

MemoRAGã¯ã€é•·æ–‡è„ˆå‡¦ç†ã®ãŸã‚ã®æ–°ã—ã„RAGãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
é€šå¸¸ã®RAGãŒã€Œè³ªå•ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã ã‘ã§æ¤œç´¢ã‚’è¡Œã†ã®ã«å¯¾ã—ã€MemoRAGã¯ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¸ã¿ã¾ã™ã€‚

1.  **Global Memory**: æ–‡è„ˆå…¨ä½“ã‚’åœ§ç¸®ã—ã¦è¨˜æ†¶ã™ã‚‹ã€‚
2.  **Clue Generation**: ãƒ¡ãƒ¢ãƒªã‹ã‚‰ã€Œæ¤œç´¢ã®æ‰‹ãŒã‹ã‚Šï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆå›ç­”ï¼‰ã€ã‚’ç”Ÿæˆã™ã‚‹ã€‚
3.  **Retrieval**: æ‰‹ãŒã‹ã‚Šã‚’ä½¿ã£ã¦æ­£ç¢ºãªè¨¼æ‹ ã‚’æ¤œç´¢ã™ã‚‹ã€‚
4.  **Generation**: è¨¼æ‹ ã¨è³ªå•ã‹ã‚‰æœ€çµ‚å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ã€‚


## ğŸš€ æ©Ÿèƒ½ãƒ»ç‰¹å¾´

* **Dual-System Architecture**:
    * **Memory Model**: é«˜é€Ÿãƒ»å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ï¼ˆGPT-3.5-turboï¼‰ã§å…¨ä½“åƒã‚’æŠŠæ¡ã€‚
    * **Generator Model**: é«˜æ€§èƒ½ãªãƒ¢ãƒ‡ãƒ«ï¼ˆGPT-4oï¼‰ã§æœ€çµ‚å›ç­”ã‚’ä½œæˆã€‚
* **Clue-Based Retrieval**:
    * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ãã®ã¾ã¾æ¤œç´¢ã«ä½¿ã†ã®ã§ã¯ãªãã€ãƒ¡ãƒ¢ãƒªã‹ã‚‰å°ãå‡ºã—ãŸã€Œå…·ä½“çš„ãªæ‰‹ãŒã‹ã‚Šã€ã‚’æ¤œç´¢ã‚¯ã‚¨ãƒªã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚
* **Contextual Understanding**:
    * å˜èªã®ä¸€è‡´ã ã‘ã§ãªãã€ç‰©èªã®ä¼ç·šã‚„æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸå›ç­”ãŒå¯èƒ½ã§ã™ã€‚

## âš ï¸ æœ¬å®Ÿè£…ã¨è«–æ–‡ã®å·®ç•°ï¼ˆImportantï¼‰

æœ¬ã‚³ãƒ¼ãƒ‰ã¯ã€MemoRAGã®**æ¨è«–ãƒ•ãƒ­ãƒ¼ï¼ˆInference Flowï¼‰ã‚’æ¦‚å¿µçš„ã«å†ç¾ã—ãŸã‚‚ã®**ã§ã‚ã‚Šã€è«–æ–‡ã®å®Ÿè£…ãã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

| æ©Ÿèƒ½ | è«–æ–‡ (Official) | æœ¬å®Ÿè£… (Conceptual) |
| :--- | :--- | :--- |
| **Global Memory** | **KVã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åœ§ç¸®** (Memory Tokens) | **è‡ªç„¶è¨€èªã«ã‚ˆã‚‹æ§‹é€ åŒ–è¦ç´„** (Prompting) |
| **Optimization** | **RLGF** (å¼·åŒ–å­¦ç¿’) ã«ã‚ˆã‚‹æœ€é©åŒ– | æ±ç”¨LLM (GPT-3.5/4o) ã‚’ãã®ã¾ã¾åˆ©ç”¨ |
| **Retrieval** | ä»»æ„ã®Retriever | FAISS (Vector Store) |

æœ¬æ¥ã®MemoRAGã¯å°‚ç”¨ã®è»½é‡ãƒ¢ãƒ‡ãƒ«ã§ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¬ãƒ™ãƒ«ã®åœ§ç¸®ã‚’è¡Œã„ã¾ã™ãŒã€æœ¬å®Ÿè£…ã§ã¯LLMã«ã‚ˆã‚‹è¦ç´„ã§ãã®æ©Ÿèƒ½ã‚’è¿‘ä¼¼ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“¦ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶
* Python 3.9+
* OpenAI API Key

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
pip install langchain langchain-openai langchain-community faiss-cpu python-dotenv

```

### ç’°å¢ƒè¨­å®š

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€OpenAIã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

```env
OPENAI_API_KEY=sk-your-api-key-here

```

## ğŸƒ å®Ÿè¡Œæ–¹æ³•

1. ãƒªãƒã‚¸ãƒˆãƒªå†…ã® `story.txt` ã«ã€èª­ã¿è¾¼ã¾ã›ãŸã„é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå°èª¬ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã‚’é…ç½®ã—ã¾ã™ã€‚ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã€Œæœ€å¾Œã®æ‰‹ç´™é…é”äººã€ã®ç‰©èªãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰
2. `main.py` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
python main.py

```

### å®Ÿè¡Œãƒ­ã‚°ã®ä¾‹

```text
âš™ï¸ Initializing Vector Database...

ğŸ§  [Step 1] Forming Global Memory...
âœ… Memory Created (Length: 437 chars)
   (Content Preview: ã€è¦ç´„ï¼šã€‘ç‰©èªã¯ã€æœ€å¾Œã®æ‰‹ç´™é…é”äººã¨ã—ã¦åƒã„ã¦ããŸä¸»äººå…¬ãŒ...)

ğŸ¤” [Step 2] Thinking about clues for: 'è—¤åŸå¥ä¸€ãŒ15å¹´å‰ã«ç™½çŸ³å¹¸å­ã®å‰ã‹ã‚‰å§¿ã‚’æ¶ˆã—ãŸæœ¬å½“ã®ç†ç”±...'
ğŸ’¡ Generated Clues: 
   ['è—¤åŸå¥ä¸€ãŒç™½çŸ³å¹¸å­ã‹ã‚‰å§¿ã‚’æ¶ˆã—ãŸç†ç”±', 'ç™½çŸ³å¹¸å­ã¨è—¤åŸå¥ä¸€ã®çµæœ«', 'ç™½çŸ³å¹¸å­ã¨è—¤åŸå¥ä¸€ã®å†ä¼š']

ğŸ” [Step 3] Retrieving evidence based on clues...
ğŸ“š Retrieved 4 chunks of evidence.

ğŸ“ [Step 4] Generating final answer...
ğŸ¤– Final Answer:
==================================================
è—¤åŸå¥ä¸€ãŒ15å¹´å‰ã«ç™½çŸ³å¹¸å­ã®å‰ã‹ã‚‰å§¿ã‚’æ¶ˆã—ãŸæœ¬å½“ã®ç†ç”±ã¯...

```

## ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

* `main.py`: MemoRAGã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè£…ï¼ˆMemory -> Clue -> Retrieve -> Generateï¼‰
* `story.txt`: æ¤œè¨¼ç”¨ã®é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

## ğŸ“š References

* **Original Paper**: [MemoRAG: Boosting Long Context Processing with Global Memory-Enhanced Retrieval Augmentation](https://arxiv.org/abs/2409.05591) (Qian et al., 2024)
* **Official Repository**: [qhjq/MemoRAG](https://github.com/qhjqhj00/MemoRAG)

## ğŸ‘¤ Author

**Shogo Miyawaki**