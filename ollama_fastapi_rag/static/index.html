<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“š VLM Ã— RAG ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ UI</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 960px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.6;
    }
    h1, h2, h3 {
      margin-top: 1.5rem;
    }
    .section {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 1rem 1.2rem;
      margin-bottom: 1.5rem;
      background: #fafafa;
    }
    .row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .preview {
      max-width: 100%;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    pre {
      white-space: pre-wrap;
      background: #f2f2f2;
      padding: 1rem;
      border-radius: 8px;
      max-height: 320px;
      overflow: auto;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }
    button {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #f0f0f0;
    }
    input[type="file"],
    input[type="text"],
    input[type="number"] {
      padding: 0.3rem 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    #status {
      font-size: 0.85rem;
      color: #555;
      margin-top: 0.5rem;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #e5f2ff;
      color: #004c98;
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }
    .contexts {
      font-size: 0.85rem;
    }
    details {
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š VLM Ã— RAG ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ UI</h1>
  <p>
    1. ç”»åƒï¼ˆPDFã®ã‚¹ã‚¯ã‚·ãƒ§ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ãªã©ï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<strong>LLaVA</strong>ãŒMarkdownã«å¤‰æ›ã—ã€<strong>ChromaDB</strong>ã«è‡ªå‹•ç™»éŒ²ã•ã‚Œã¾ã™ã€‚<br>
    2. ãã®å¾Œã€ã€Œè³ªå•ã™ã‚‹ã€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ—¥æœ¬èªã§è³ªå•ã§ãã¾ã™ã€‚
  </p>

  <!-- ç”»åƒ â†’ Markdown â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ -->
  <section class="section">
    <h2>â‘  ç”»åƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è§£æã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</h2>
    <form id="form-analyze">
      <div class="row" style="margin-bottom: 0.5rem;">
        <input type="file" id="file" accept="image/*" required />
        <button type="submit">è§£æã—ã¦ç™»éŒ²ã™ã‚‹</button>
        <span id="status"></span>
      </div>
    </form>

    <img id="preview" class="preview" style="display:none;" />

    <h3>ç”Ÿæˆã•ã‚ŒãŸ Markdown <span id="doc-meta" class="badge" style="display:none;"></span></h3>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <pre id="output"></pre>
  </section>

  <!-- è³ªå• â†’ RAGå›ç­” -->
  <section class="section">
    <h2>â‘¡ ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è³ªå•ã™ã‚‹</h2>
    <form id="form-query">
      <div class="row" style="margin-bottom: 0.5rem;">
        <input
          type="text"
          id="question"
          placeholder="ä¾‹ï¼šã“ã®è³‡æ–™ã®å®Ÿé¨“æ¡ä»¶ã¯ï¼Ÿ"
          style="flex: 1 1 320px;"
          required
        />
        <label>
          top_k:
          <input type="number" id="top_k" value="5" min="1" max="10" style="width:60px;" />
        </label>
        <button type="submit">è³ªå•ã™ã‚‹</button>
      </div>
    </form>

    <h3>å›ç­”</h3>
    <pre id="answer"></pre>

    <details>
      <summary>å‚ç…§ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰</summary>
      <div id="contexts" class="contexts"></div>
    </details>
  </section>

  <script>
    const fileInput = document.getElementById("file");
    const preview = document.getElementById("preview");
    const output = document.getElementById("output");
    const copyBtn = document.getElementById("copy");
    const statusEl = document.getElementById("status");
    const docMeta = document.getElementById("doc-meta");

    const formAnalyze = document.getElementById("form-analyze");
    const formQuery = document.getElementById("form-query");
    const questionInput = document.getElementById("question");
    const topKInput = document.getElementById("top_k");
    const answerEl = document.getElementById("answer");
    const contextsEl = document.getElementById("contexts");

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";
      statusEl.textContent = "";
      output.textContent = "";
      docMeta.style.display = "none";
    });

    // â‘  ç”»åƒ â†’ Markdown â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    formAnalyze.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) {
        alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      statusEl.textContent = "è§£æä¸­...ï¼ˆæ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰";
      const fd = new FormData();
      fd.append("file", file);

      try {
        const res = await fetch("/api/analyze", { method: "POST", body: fd });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();
        output.textContent = data.markdown || "è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
        statusEl.textContent = `å®Œäº†: ${data.exec_time_sec?.toFixed?.(2) ?? "?"} ç§’`;

        if (data.source_id) {
          docMeta.textContent = `source_id: ${data.source_id} / chunks: ${data.num_chunks}`;
          docMeta.style.display = "inline-block";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        alert("è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    });

    // Markdown ã‚³ãƒ”ãƒ¼
    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(output.textContent);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      } catch (e) {
        alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    });

    // â‘¡ RAG ã«è³ªå•
    formQuery.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = questionInput.value.trim();
      if (!question) return;

      answerEl.textContent = "å•ã„åˆã‚ã›ä¸­...";
      contextsEl.textContent = "";

      const top_k = Number(topKInput.value || "5");

      try {
        const res = await fetch("/api/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, top_k }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${res.status}`);
        }
        const data = await res.json();
        answerEl.textContent = data.answer || "å›ç­”ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ";

        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        const docs = data.contexts?.documents || [];
        const metas = data.contexts?.metadatas || [];

        if (!docs.length) {
          contextsEl.textContent = "å‚ç…§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }

        contextsEl.innerHTML = "";
        docs.forEach((doc, i) => {
          const meta = metas[i] || {};
          const div = document.createElement("div");
          div.style.marginBottom = "0.75rem";
          const header = document.createElement("div");
          header.style.fontWeight = "bold";
          header.textContent = `[${i + 1}] source=${meta.source || ""} title=${meta.title || ""}`;
          const pre = document.createElement("pre");
          pre.textContent = doc;
          div.appendChild(header);
          div.appendChild(pre);
          contextsEl.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        answerEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        alert("ã‚¯ã‚¨ãƒªã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
      }
    });
  </script>
</body>
</html>
