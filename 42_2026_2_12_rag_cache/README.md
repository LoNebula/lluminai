# ðŸŒ² RAGCache Simulator (Python)

è«–æ–‡ **"RAGCache: Efficient Knowledge Caching for Retrieval-Augmented Generation"** ã§ææ¡ˆã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã§ã™ã€‚

RAGï¼ˆRetrieval-Augmented Generationï¼‰ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚‹ã€ŒPrefillãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã®å‡¦ç†ï¼‰ã€ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã®ã€**Knowledge Treeï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãƒ„ãƒªãƒ¼ï¼‰** æ§‹é€ ã¨ **PGDSF** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç½®æ›ãƒãƒªã‚·ãƒ¼ã®æŒ™å‹•ã‚’Pythonã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚

## ðŸ“– æ¦‚è¦

RAGã§ã¯ã€æ¤œç´¢ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã‚„é †åºã«ã‚ˆã£ã¦ã€LLMã®KVã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆKey-Value Cacheï¼‰ã®çŠ¶æ…‹ãŒå¤‰åŒ–ã—ã¾ã™ã€‚ãã®ãŸã‚ã€å˜ç´”ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå˜ä½ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯å†åˆ©ç”¨çŽ‡ãŒä¸ŠãŒã‚Šã¾ã›ã‚“ã€‚

**RAGCache** ã¯ä»¥ä¸‹ã®æ‰‹æ³•ã§ã“ã‚Œã‚’è§£æ±ºã—ã¾ã™ï¼š

1. **Knowledge Tree**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸¦ã³é †ï¼ˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼‰ã‚’ãƒ„ãƒªãƒ¼æ§‹é€ ã¨ã—ã¦ç®¡ç†ã—ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆå…ˆè¡Œã™ã‚‹æ–‡è„ˆï¼‰ãŒä¸€è‡´ã™ã‚‹å ´åˆã«ã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…±æœ‰ã—ã¾ã™ã€‚
2. **PGDSF Policy**: é™ã‚‰ã‚ŒãŸGPUãƒ¡ãƒ¢ãƒªã‚’æœ‰åŠ¹æ´»ç”¨ã™ã‚‹ãŸã‚ã€é »åº¦ãƒ»ã‚µã‚¤ã‚ºãƒ»å†è¨ˆç®—ã‚³ã‚¹ãƒˆãƒ»é®®åº¦ã‚’è€ƒæ…®ã—ãŸã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’è¡Œã„ã€æœ€é©ãªãƒŽãƒ¼ãƒ‰ã‚’ä¿æŒã—ã¾ã™ã€‚

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã¯ã€vLLMãªã©ã®æŽ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³ã¸çµ„ã¿è¾¼ã‚€å‰ã®ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

## ðŸš€ ç‰¹å¾´

* **Knowledge Treeã®å®Ÿè£…**: è¦ªãƒŽãƒ¼ãƒ‰ï¼ˆç›´å‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã¸ã®ä¾å­˜é–¢ä¿‚ã‚’æŒã¤ãƒŽãƒ¼ãƒ‰ç®¡ç†ã€‚
* **PGDSFã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: ä»¥ä¸‹ã®å¼ã«åŸºã¥ãå„ªå…ˆåº¦è¨ˆç®—ã®å®Ÿè£…ã€‚


* **ãƒ¡ãƒ¢ãƒªéšŽå±¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: `DISK` -> `HOST` (CPU) -> `GPU` é–“ã®ãƒ‡ãƒ¼ã‚¿ç§»å‹•ã¨ã€å®¹é‡ä¸è¶³æ™‚ã®é€€é¿ï¼ˆEvictionï¼‰ãƒ­ã‚¸ãƒƒã‚¯ã€‚

## ðŸ›  ä½¿ã„æ–¹

### å¿…è¦è¦ä»¶

* Python 3.x
* å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä¸è¦ï¼ˆæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª `heapq`, `time` ã®ã¿ä½¿ç”¨ï¼‰

### å®Ÿè¡Œæ–¹æ³•

ã‚³ãƒ¼ãƒ‰ã‚’ `main.py` ã¨ã—ã¦ä¿å­˜ã—ã€å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

```bash
python main.py

```

### ã‚³ãƒ¼ãƒ‰ä¾‹

`RAGCacheSimulator` ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ä¸€é€£ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹æ§˜å­ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã¾ã™ã€‚

```python
# GPUå®¹é‡ 350, Hostå®¹é‡ 1000 ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
sim = RAGCacheSimulator(gpu_capacity=350, host_capacity=1000)

# 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [D1, D2] ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ -> ä¸¡æ–¹GPUã«ãƒ­ãƒ¼ãƒ‰
sim.access_sequence(["D1", "D2"])

# 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [D1, D3] ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 
# -> D1ã¯å…±é€šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥HITã€D3ã®ã¿æ–°è¦ãƒ­ãƒ¼ãƒ‰
sim.access_sequence(["D1", "D3"])

# 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ [D4, D5] ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ 
# -> å®¹é‡ä¸è¶³ã®ãŸã‚ã€å„ªå…ˆåº¦ã®ä½Žã„ãƒŽãƒ¼ãƒ‰ï¼ˆD2ã‚„D3ãªã©ï¼‰ãŒEvictã•ã‚Œã‚‹
sim.access_sequence(["D4", "D5"])

```

## ðŸ“Š å‡ºåŠ›ä¾‹

å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ’ãƒƒãƒˆ/ãƒŸã‚¹ã€ãŠã‚ˆã³GPUãƒ¡ãƒ¢ãƒªã‹ã‚‰ã®é€€é¿ï¼ˆEvictionï¼‰ã®ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```text
--- Step 1: Request [D1, D2] ---
ðŸ”„ Miss! Loading D1 to GPU...
   -> Promoted D1 to GPU. Usage: 110/350
ðŸ”„ Miss! Loading D2 to GPU...
   -> Promoted D2 to GPU. Usage: 210/350

--- Step 2: Request [D1, D3] (D1 should hit) ---
âœ… Hit! D1 is in GPU.
ðŸ”„ Miss! Loading D3 to GPU...
   -> Promoted D3 to GPU. Usage: 310/350

--- Step 3: Request [D4, D5] (Forces eviction) ---
ðŸ”„ Miss! Loading D4 to GPU...
   ðŸ‘‹ Evicted D2 (P=0.10) to HOST.
   -> Promoted D4 to GPU. Usage: 310/350
...

```

## ðŸ§  æŠ€è¡“è§£èª¬

### Knowledge Treeï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãƒ„ãƒªãƒ¼ï¼‰

é€šå¸¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã¨ã¯ç•°ãªã‚Šã€RAGCacheã¯ãƒŽãƒ¼ãƒ‰ã‚’ãƒ„ãƒªãƒ¼å½¢å¼ã§ç®¡ç†ã—ã¾ã™ã€‚

* **Root**: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå¸¸ã«å…±æœ‰ï¼‰ã€‚
* **Path**: ä¾‹ãˆã° `Root -> D1 -> D2` ã¨ã„ã†ãƒ‘ã‚¹ã¯ã€ã€Œã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + Doc1 + Doc2ã€ã¨ã„ã†æ–‡è„ˆã‚’è¡¨ã—ã¾ã™ã€‚
* **Prefix Awareness**: LLMã®Attentionã¯é †åºã«ä¾å­˜ã™ã‚‹ãŸã‚ã€`[D1, D2]` ã®å¾Œã« `[D1, D3]` ãŒæ¥ãŸå ´åˆã€`D1` ã®KVã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å†åˆ©ç”¨å¯èƒ½ã§ã™ãŒã€`[D2, D1]` ãŒæ¥ãŸå ´åˆã¯ `D1` ã‚’å†åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ„ãƒªãƒ¼æ§‹é€ ã¯ã“ã®åˆ¶ç´„ã‚’è‡ªç„¶ã«è§£æ±ºã—ã¾ã™ã€‚

### PGDSF (Prefix-aware Greedy-Dual-Size-Frequency)

ã©ã®ãƒŽãƒ¼ãƒ‰ã‚’GPUã«æ®‹ã™ã‹ã‚’æ±ºå®šã™ã‚‹ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚

* **Clock (L)**: è«–ç†æ™‚è¨ˆã€‚æ™‚é–“ã®çµŒéŽã¨ã¨ã‚‚ã«å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¾¡å€¤ã‚’ä¸‹ã’ã‚‹ï¼ˆEvictionç™ºç”Ÿæ™‚ã«æ›´æ–°ï¼‰ã€‚
* **Frequency**: ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ã€‚
* **Cost/Size**: ã€Œã‚µã‚¤ã‚ºãŒå°ã•ãã€ã‹ã¤å†è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã€ãƒŽãƒ¼ãƒ‰ã‚’å„ªå…ˆçš„ã«ä¿æŒã—ã¾ã™ã€‚

## ðŸ“š å‚è€ƒæ–‡çŒ®

æœ¬ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®è«–æ–‡ã®æ¦‚å¿µå®Ÿè¨¼ï¼ˆPoCï¼‰å®Ÿè£…ã§ã™ã€‚

> **RAGCache: Efficient Knowledge Caching for Retrieval-Augmented Generation**
> *Chao Jin, Xuanlin Jiang, Fangyue Liu, et al.*
> arXiv:2404.12457 [cs.DC]
> [https://arxiv.org/abs/2404.12457](https://arxiv.org/abs/2404.12457)